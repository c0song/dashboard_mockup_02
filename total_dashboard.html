<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KDT Total Track Summary Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Pretendard', sans-serif; }
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #d1d5db; height: 100vh; position: fixed; padding: 20px; z-index: 100; }
        .main-content { margin-left: 260px; padding: 24px; }
        .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .status-pill { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 600; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-closed { background: #fee2e2; color: #991b1b; }
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 11px; font-weight: 700; color: #4a5568; text-transform: uppercase; margin-bottom: 6px; display: block; }
        select { width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="mb-8 font-bold text-xl text-[#00A699]">KDT Control Tower</div>
    <div class="filter-group">
        <label class="filter-label">Track Name</label>
        <select id="track-select" onchange="selectedTrack = this.value; updateCharts()">
            <option value="all" selected>전체</option>
            <option value="fullstack">풀스택</option>
            <option value="flutter">Flutter</option>
            <option value="drive">자율주행</option>
            <option value="unreal">언리얼</option>
        </select>
    </div>
    <div class="filter-group">
        <label class="filter-label">Cohort (Global Filter)</label>
        <select id="cohort-select">
            <option value="all" selected>전체</option>
            <option value="1">1기</option>
            <option value="2">2기</option>
            <option value="3">3기</option>
        </select>
    </div>
</aside>

<main class="main-content">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-slate-800">전체 트랙 요약 대시보드</h1>
        <p class="text-slate-500 mt-1">실시간 트랙별 학습 현황 및 성과 분석</p>
    </div>

    <div id="view-total">
        <div class="grid grid-cols-12 gap-6 mb-6">
            <div class="col-span-4 card h-[600px]">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">도메인 상태</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="gauge-fullstack-container" class="text-center">
                        <div id="gauge-fullstack" style="height: 180px;"></div>
                    </div>
                    <div id="gauge-flutter-container" class="text-center">
                        <div id="gauge-flutter" style="height: 180px;"></div>
                    </div>
                    <div id="gauge-drive-container" class="text-center">
                        <div id="gauge-drive" style="height: 180px;"></div>
                    </div>
                    <div id="gauge-unreal-container" class="text-center">
                        <div id="gauge-unreal" style="height: 180px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-span-4 card h-[300px]">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">트랙별/기수별 인원 분포 (Treemap)</h3>
                <div id="chart-treemap" style="height: 250px;"></div>
            </div>
            <div class="col-span-4 card h-[300px]">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">트랙별 평균 수료율 (Target: 70%)</h3>
                <div id="chart-completion" style="height: 250px;"></div>
            </div>
        </div>

            <div class="col-span-6 card h-[300px]">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">트랙 학습률 분포</h3>
                <div id="chart-violin-learning" style="height: 250px;"></div>
            </div>
            <div class="col-span-6 card h-[300px]">
                <h3 class="font-bold text-slate-700 mb-2 text-sm">트랙 테스트응시율 분포</h3>
                <div id="chart-violin-attendance" style="height: 250px;"></div>
            </div>
        </div>
    </div>
</main>

<script>
    let selectedTrack = 'all';

    function updateCharts() {
        document.getElementById('track-select').value = selectedTrack;
        if (selectedTrack === 'all') {
            document.getElementById('cohort-select').disabled = true;
            document.getElementById('cohort-select').value = 'all';
        } else {
            document.getElementById('cohort-select').disabled = false;
            document.getElementById('cohort-select').value = 'all';
        }
        renderTotalView();
    }

    // [Chart 1] Treemap: 인원수
    function renderTotalView() {
        const renderGauge = (id, val, title, maxVal) => {
            const g = echarts.init(document.getElementById(id));
            g.setOption({
                title: { text: title, left: 'center', top: 'bottom', textStyle: { fontSize: 12 } },
                series: [{ 
                    type: 'gauge', 
                    min: 0, 
                    max: maxVal, 
                    progress: { show: true }, 
                    detail: { formatter: '{value}ms', fontSize: 14 },
                    data: [{ value: val }], 
                    axisLine: { lineStyle: { width: 10 } } 
                }]
            });
        };

        // 도메인 상태 게이지 표시 조건부
        const showFullstack = selectedTrack === 'all' || selectedTrack === 'fullstack';
        const showFlutter = selectedTrack === 'all' || selectedTrack === 'flutter';
        const showDrive = selectedTrack === 'all' || selectedTrack === 'drive';
        const showUnreal = selectedTrack === 'all' || selectedTrack === 'unreal';
        document.getElementById('gauge-fullstack-container').style.display = showFullstack ? 'block' : 'none';
        document.getElementById('gauge-flutter-container').style.display = showFlutter ? 'block' : 'none';
        document.getElementById('gauge-drive-container').style.display = showDrive ? 'block' : 'none';
        document.getElementById('gauge-unreal-container').style.display = showUnreal ? 'block' : 'none';

        if (showFullstack) renderGauge('gauge-fullstack', 75, '풀스택', 100);
        if (showFlutter) renderGauge('gauge-flutter', 45, 'Flutter', 100);
        if (showDrive) renderGauge('gauge-drive', 120, '자율주행', 200);
        if (showUnreal) renderGauge('gauge-unreal', 32, '언리얼', 100);
        const tree = echarts.init(document.getElementById('chart-treemap'));
        const trackColors = {
            '풀스택': '#ff0000',
            'Flutter': '#0000ff',
            '자율주행': '#00ff00',
            '언리얼': '#ffbf00'
        };
        let treemapData;
        if (selectedTrack === 'all') {
            treemapData = [
                { name: '풀스택', value: 42, itemStyle: { color: trackColors['풀스택'] } },
                { name: 'Flutter', value: 50, itemStyle: { color: trackColors['Flutter'] } },
                { name: '자율주행', value: 40, itemStyle: { color: trackColors['자율주행'] } },
                { name: '언리얼', value: 50, itemStyle: { color: trackColors['언리얼'] } }
            ];
        } else {
            const trackMap = {
                fullstack: { name: '풀스택', color: trackColors['풀스택'], children: [{name:'1기', value:27}, {name:'2기', value:15}, {name:'3기', value:0}] },
                flutter: { name: 'Flutter', color: trackColors['Flutter'], children: [
                    {name:'1기', value:10}, {name:'2기', value:9}, {name:'3기', value:10}, 
                    {name:'4기', value:9}, {name:'5기', value:7}, {name:'6기', value:5}
                ]},
                drive: { name: '자율주행', color: trackColors['자율주행'], children: [{name:'1기', value:25}, {name:'2기', value:15}] },
                unreal: { name: '언리얼', color: trackColors['언리얼'], children: [{name:'1기', value:50}] }
            };
            const trackData = trackMap[selectedTrack];
            const maxVal = Math.max(...trackData.children.map(c => c.value));
            const baseColor = trackData.color;
            const rgb = hexToRgb(baseColor);
            treemapData = [{
                name: trackData.name,
                children: trackData.children.map(c => ({
                    ...c,
                    itemStyle: { color: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${c.value / maxVal})` }
                }))
            }];
        }
        tree.setOption({
            series: [{
                type: 'treemap',
                nodeClick: selectedTrack === 'all' ? 'zoomToNode' : false,
                data: treemapData,
                label: { show: true, formatter: '{b}\n{c}명' }
            }]
        });
        if (selectedTrack === 'all') {
            tree.on('click', (params) => {
                if (params.data && !params.data.children) {
                    let trackName = params.data.name;
                    if (trackName === '풀스택') selectedTrack = 'fullstack';
                    else if (trackName === 'Flutter') selectedTrack = 'flutter';
                    else if (trackName === '자율주행') selectedTrack = 'drive';
                    else if (trackName === '언리얼') selectedTrack = 'unreal';
                    updateCharts();
                }
            });
        } else {
            tree.off('click');
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // [Chart 2] Completion Rate: Bar + Line
        const comp = echarts.init(document.getElementById('chart-completion'));
        const trackNameMap = {
            fullstack: '풀스택',
            flutter: 'Flutter',
            drive: '자율주행',
            unreal: '언리얼'
        };
        let cohorts = [];
        let completionData = [];
        if (selectedTrack === 'all') {
            cohorts = ['풀스택', 'Flutter', '자율주행', '언리얼'];
            completionData = [78, 92, 88, 95];
        } else {
            const cohortMap = {
                fullstack: { cohorts: ['1기', '2기', '3기'], rates: [80, 75, 0] },
                flutter: { cohorts: ['1기', '2기', '3기', '4기', '5기', '6기'], rates: [90, 85, 95, 88, 92, 94] },
                drive: { cohorts: ['1기', '2기'], rates: [85, 90] },
                unreal: { cohorts: ['1기'], rates: [95] }
            };
            cohorts = cohortMap[selectedTrack].cohorts;
            completionData = cohortMap[selectedTrack].rates;
        }
        comp.setOption({
            xAxis: { type: 'category', data: cohorts },
            yAxis: { type: 'value', max: 100 },
            series: [
                { name: '수료율', type: 'bar', 
                  data: completionData.map((val, idx) => ({ 
                      value: val, 
                      itemStyle: { color: selectedTrack === 'all' ? trackColors[cohorts[idx]] : trackColors[trackNameMap[selectedTrack]] } 
                  })),
                  label: { show: true, position: 'top', formatter: '{c}%' },
                  markLine: { data: [{ yAxis: 70, name: 'Target', lineStyle: { color: '#ef4444' } }] }
                }
            ]
        });

        // [Chart 4] Violin (Learning)
        const violinLearning = echarts.init(document.getElementById('chart-violin-learning'));
        let violinCohortsLearning = [];
        let violinDataLearning = [];
        if (selectedTrack === 'all') {
            violinCohortsLearning = ['풀스택', 'Flutter', '자율주행', '언리얼'];
            violinDataLearning = [[10, 40, 50, 70, 90], [60, 80, 85, 90, 98], [70, 75, 80, 85, 95], [80, 85, 90, 95, 100]];
        } else {
            const cohortMap = {
                fullstack: { cohorts: ['1기', '2기', '3기'], data: [[20, 50, 60, 75, 85], [15, 45, 55, 70, 80], [0, 0, 0, 0, 0]] },
                flutter: { cohorts: ['1기', '2기', '3기', '4기', '5기', '6기'], data: [[70, 85, 90, 95, 100], [65, 80, 85, 90, 95], [75, 90, 95, 98, 100], [60, 75, 80, 85, 90], [80, 90, 95, 98, 100], [85, 95, 98, 100, 100]] },
                drive: { cohorts: ['1기', '2기'], data: [[75, 80, 85, 90, 95], [80, 85, 90, 95, 100]] },
                unreal: { cohorts: ['1기'], data: [[85, 90, 95, 98, 100]] }
            };
            violinCohortsLearning = cohortMap[selectedTrack].cohorts;
            violinDataLearning = cohortMap[selectedTrack].data;
        }
        violinLearning.setOption({
            xAxis: { type: 'category', data: violinCohortsLearning },
            yAxis: { type: 'value' },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    const data = params.data;
                    return `최소: ${data[0]}%<br>1사분위: ${data[1]}%<br>중앙값: ${data[2]}%<br>3사분위: ${data[3]}%<br>최대: ${data[4]}%`;
                }
            },
            series: [{ type: 'boxplot', data: violinDataLearning }]
        });

        // [Chart 5] Violin (Attendance)
        const violinAttendance = echarts.init(document.getElementById('chart-violin-attendance'));
        let violinCohortsAttendance = [];
        let violinDataAttendance = [];
        if (selectedTrack === 'all') {
            violinCohortsAttendance = ['풀스택', 'Flutter', '자율주행', '언리얼'];
            violinDataAttendance = [[5, 30, 45, 65, 85], [55, 75, 80, 85, 95], [65, 70, 75, 80, 90], [75, 80, 85, 90, 95]];
        } else {
            const cohortMap = {
                fullstack: { cohorts: ['1기', '2기', '3기'], data: [[10, 40, 50, 65, 75], [10, 35, 45, 60, 70], [0, 0, 0, 0, 0]] },
                flutter: { cohorts: ['1기', '2기', '3기', '4기', '5기', '6기'], data: [[60, 75, 80, 85, 90], [55, 70, 75, 80, 85], [65, 80, 85, 90, 95], [50, 65, 70, 75, 80], [70, 80, 85, 90, 95], [75, 85, 90, 95, 100]] },
                drive: { cohorts: ['1기', '2기'], data: [[65, 70, 75, 80, 85], [70, 75, 80, 85, 90]] },
                unreal: { cohorts: ['1기'], data: [[75, 80, 85, 90, 95]] }
            };
            violinCohortsAttendance = cohortMap[selectedTrack].cohorts;
            violinDataAttendance = cohortMap[selectedTrack].data;
        }
        violinAttendance.setOption({
            xAxis: { type: 'category', data: violinCohortsAttendance },
            yAxis: { type: 'value' },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    const data = params.data;
                    return `최소: ${data[0]}%<br>1사분위: ${data[1]}%<br>중앙값: ${data[2]}%<br>3사분위: ${data[3]}%<br>최대: ${data[4]}%`;
                }
            },
            series: [{ type: 'boxplot', data: violinDataAttendance }]
        });
    }

    document.getElementById('current-time').innerText = new Date().toLocaleString();
    updateCharts();
</script>
</body>
</html>